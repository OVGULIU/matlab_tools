clear all
close all
clc

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INSTRUMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% NUMBER OF POINTS IN X,Y,Z (GET FROM PYTHON FILE)
NX  = 15; NY  = 1; NZ  = 7;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MATERIAL
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
E   = 200;          % [GPa]
nu  = 0.3;          % [-]
pkid_ave    = 4:8;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PAR FILE DESIGNATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pname_pypar     = './strain-examples/';
fname_pypar     = 'mach_feb15_TOA_7_Lap7.pypar';
pfname_pypar    = fullfile(pname_pypar, fname_pypar);
pardata         = ReadPythonParFile(pfname_pypar);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PATH WHERE DATA FILES LIVE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pname_data  = './strain-examples/Lap7/';

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% FILE NAME FOR STRAIN
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
fname_strain_v  = 'mach_feb15_strain_v.csv';
fname_strain_h  = 'mach_feb15_strain_h.csv';

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END OF INPUTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
XS  = pardata.samX;
YS  = pardata.samY;
ZS  = pardata.samZ;

xs  = reshape(XS', NX, NY, NZ);
ys  = reshape(YS', NX, NY, NZ);
zs  = reshape(ZS', NX, NY, NZ);

numDV   = length(pardata.day);

strain_v    = csvread(fname_strain_v);
strain_h    = csvread(fname_strain_h);
    
e_vv    = mean(strain_v(:,pkid_ave + 3), 2);
e_hh    = mean(strain_h(:,pkid_ave + 3), 2);

return

for i = 1:1:length(pkid_fit)
    strain  = E_hkl(pkid_fit(i))./Efit(:,i) - 1;
    
    figure(100 + i)
    set(gcf, 'Position', [120 450 1140 515])
    subplot(2,3,1)
    scatter3(XS, YS, ZS, 50, Afit(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('peak amplitude (cts)')
    
    subplot(2,3,2)
    scatter3(XS, YS, ZS, 50, gfit(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('peak width (keV)')
    
    subplot(2,3,3)
    scatter3(XS, YS, ZS, 50, nfit(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('mix parameter')
    
    subplot(2,3,4)
    scatter3(XS, YS, ZS, 50, Efit(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('E fit (keV)')
    
    subplot(2,3,5)
    scatter3(XS, YS, ZS, 50, Rwp(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('peak fit weigted residual')
    
    subplot(2,3,6)
    scatter3(XS, YS, ZS, 50, strain, 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('strain')
    caxis([-3e-3 3e-3])
    
    Strain(:,i) = strain;
end

output  = [XS YS ZS Strain];
xlswrite(fname_strain, output)
