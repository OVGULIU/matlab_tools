clear all
close all
clc

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INSTRUMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
TOA  = 6.97005;
ChToEnergyConversion  = [0.0925699 -0.0754175];
MeasurementPlane    = 'h';

%%% NUMBER OF POINTS IN X,Y,Z (GET FROM PYTHON FILE)
NX  = 15; NY  = 1; NZ  = 7;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MATERIAL
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BCC Fe
latticeParms    = 2.868 ;                        % IN Angstrom
hkls            = load('bcc.hkls');
d_hkl           = PlaneSpacings(latticeParms, 'cubic', hkls');
pkid_fit        = 4:8;
sqrt_hkls       = sqrt(sum(hkls(pkid_fit, :).*hkls(pkid_fit, :),2));
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PAR FILE DESIGNATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pname_pypar     = './strain-examples/';
fname_pypar     = 'mach_feb15_TOA_7_Lap7.pypar';
pfname_pypar    = fullfile(pname_pypar, fname_pypar);
pardata         = ReadPythonParFile(pfname_pypar);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PATH WHERE DATA FILES LIVE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
pname_data  = './strain-examples/Lap7/';

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% END OF INPUTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
XS  = pardata.samX;
YS  = pardata.samY;
ZS  = pardata.samZ;

xs  = reshape(XS, NX, NZ);
zs  = reshape(ZS, NX, NZ);

lambda_hkl  = 2.*d_hkl*sind(TOA/2);
E_hkl       = Angstrom2keV(lambda_hkl);

E_grid  = 1:1:2048;
E_grid  = ChToEnergyConversion(1)*E_grid + ChToEnergyConversion(2);

numDV   = length(pardata.day);
for i = 1:1:numDV
    if strcmpi(MeasurementPlane, 'h')
        fname   = pardata.HorzFileName{i}(1:end-1);
    elseif strcmpi(MeasurementPlane, 'v')
        fname   = pardata.VertFileName{i}(1:end-1);
    end
    
    fname_fit   = [fname, '.fit.mat'];
    pfname_fit  = fullfile(pname_data, fname_fit);
    
    fit_data    = load(pfname_fit);
    
    Efit(i,:)   = fit_data.Efit;
    Afit(i,:)   = fit_data.Afit;
    gfit(i,:)   = fit_data.gfit;
    nfit(i,:)   = fit_data.nfit;
    rn(i,:)     = fit_data.rn;
    
    Rwp(i,:)    = fit_data.Rwp;
    Rp(i,:)     = fit_data.Rp;
    Re(i,:)     = fit_data.Re; 
end

for i = 1:1:length(pkid_fit)
    strain  = E_hkl(pkid_fit(i))./Efit(:,i) - 1;
    
    c   = reshape(Afit(:,i), NX, NY, NZ);
    figure(100 + i)
    subplot(2,3,1)
    contourslice(xs, ys, zs, c, 1:9, [], 0, linspace(-8,2,10))
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('peak amplitude (cts)')
    return
    
    subplot(2,3,2)
    scatter3(XS, YS, ZS, 50, gfit(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('peak width (keV)')
    
    subplot(2,3,3)
    scatter3(XS, YS, ZS, 50, nfit(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('mix parameter')
    
    subplot(2,3,4)
    scatter3(XS, YS, ZS, 50, Efit(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('E fit (keV)')
    
    subplot(2,3,5)
    scatter3(XS, YS, ZS, 50, Rwp(:,i), 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('peak fit weigted residual')
    
    subplot(2,3,6)
    scatter3(XS, YS, ZS, 50, strain, 'filled')
    colorbar vert
    xlabel('X (mm)')
    ylabel('Y (mm)')
    zlabel('Z (mm)')
    title('strain')
end
