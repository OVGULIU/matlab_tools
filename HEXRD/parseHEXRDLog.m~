% function log = parseHEXRDLog(pfname)
% parseHEXRDLog Parse a Grainspotter log-like HEXRD log file.
%
%   log = parseGrainSpotterLog(fileName) reads the Grainspotter log file
%   with the name fileName and returns the information in an array of
%   structures with fields:
%       nExpGvec = Number of expected G vectors
%       nMeasGvec = Number of measured G vectors
%       nMeasOnce = Number of G vectors measured once
%       nMeasMore = Number of G vectors measured more than once
%       meanIA = Average internal angle between prediced and measured
%       U = 3x3 Orientation matrix
%       gvec = G vector table
%       hkl = 3 hkl values
%
%   The columns of the log file are:
%     n gvector_id peak_id  h k l  h_pred k_pred l_pred  dh dk dl
%     tth_meas tth_pred dtth  omega_meas omega_pred domega
%     eta_meas  eta_pred deta  IA
%
%   Example:
%     log = parseGrainSpotterLog('simul.log');

clear all
close all
clc

pname   = 'C:\Users\s1iduser\Documents\GitHub\matlab_tools\HEXRD';
fname   = 'grainlist_44,45.log';
pfname  = fullfile(pname, fname);

fid = fopen(pfname, 'r');
if(fid == -1)
    beep;
    error('Cannot open file:\n  %s\n', fileName);
end

nGrains = 0;
while ~feof(fid)
    line = fgetl(fid);
    if strfind(line, '#### grain') == 1
        nGrains  = nGrains + 1;
    end
end

% Rewind file
fseek(fid, 0, -1);

% Loop over found grains
log(nGrains) = struct(...
    'Quat',[],'R',[],'V',[],'Esam',[],'Ecry',[],'F',[], ...
    'lattprms',[], 'COM', [], 'ReflectionTable', [], 'Completeness', []);

while ~feof(fid)
    line = fgetl(fid);    
    if strfind(line, '#### grain') == 1
        grnum   = str2double(line(11:end)) + 1;
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        fgetl(fid);
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 1;
        log(grnum).Quat = str2num(line(idx:end-1));
        
        %%% LINE SKIP
        fgetl(fid);
        
        R       = zeros(3,3);
        line    = fgetl(fid);
        idx     = strfind(line, '[[') + 2;
        R(1,:)  = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx 	= strfind(line, '[') + 1;
        R(2,:)  = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 2;
        R(3,:)  = str2num(line(idx:end-2));
        log(grnum).R    = R;
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        fgetl(fid);
        
        V       = zeros(3,3);
        line    = fgetl(fid);
        idx     = strfind(line, '[[') + 2;
        V(1,:)  = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 1;
        V(2,:)  = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 2;
        V(3,:)  = str2num(line(idx:end-2));
        log(grnum).V    = V;
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        fgetl(fid);
        
        Esam    = zeros(3,3);
        line    = fgetl(fid);
        idx     = strfind(line, '[[') + 2;
        Esam(1,:)   = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 1;
        Esam(2,:)   = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 2;
        Esam(3,:)   = str2num(line(idx:end-2)); 
        log(grnum).Esam = Esam;
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        fgetl(fid);
        
        Ecry    = zeros(3,3);
        line    = fgetl(fid);
        idx     = strfind(line, '[[') + 2;
        Ecry(1,:)   = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 1;
        Ecry(2,:)   = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 2;
        Ecry(3,:)   = str2num(line(idx:end-2)); 
        log(grnum).Ecry = Ecry;
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        fgetl(fid);
        
        F       = zeros(3,3);
        line    = fgetl(fid);
        idx     = strfind(line, '[[') + 2;
        F(1,:)  = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 1;
        F(2,:)  = str2num(line(idx:end-2));
        
        line    = fgetl(fid);
        idx     = strfind(line, '[') + 2;
        F(3,:)  = str2num(line(idx:end-2)); 
        log(grnum).F    = F;
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        fgetl(fid);
        
        line    = fgetl(fid);
        log(grnum).lattprms = str2num(line(2:end));
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        
        line    = fgetl(fid);
        idx     = strfind(line, '(') + 1;
        log(grnum).COM  = str2num(line(idx:end-1));
        
        %%% LINE SKIP
        fgetl(fid);
        fgetl(fid);
        fgetl(fid);
        
        EndOfTable  = 0;
        ReflectionTable = [];
        while ~EndOfTable
            line    = fgetl(fid);
            ReflectionTable = [ReflectionTable; str2num(line)];
            if strfind(line, '#')
                EndOfTable  = 1;
            end
        end
        log(grnum).ReflectionTable  = ReflectionTable;
        
        %%% LINE SKIP
        line    = fgetl(fid);
        idx     = strfind(line, '(') + 1;
        Completeness
        return
    end
end
fclose(fid);
return
for i = 1:1:nGrains
    fgetl(fid);  % Grain nnn, nPairs (Skip)
    
    
    line    = fgetl(fid);
    parms   = sscanf(line, '%d %d %d %d');
    
    log(i).nExpGvec     = parms(1);
    log(i).nMeasGvec    = parms(2);
    log(i).nMeasOnce    = parms(3);
    log(i).nMeasMore    = parms(4);
    
    line    = fgetl(fid);
    parms   = sscanf(line, '%f');  % May be more items with 0.5 and above
    
    log(i).meanIA = parms(1);
    
    C           = textscan(fid, '%f', 9);
    log(i).U    = reshape(C{1}(1:9), 3, 3)';
    
    % Skip 3 lines
    textscan(fid, '%*[^\n]', 3);
    C   = textscan(fid, '%f', 3);
    log(i).Rod  = reshape(C{1}(1:3),3,1);
    
    % Skip 1 line
    % textscan(fid, '%*[^\n]', 1)
    C               = textscan(fid, '%f', 3);
    log(i).Bunge    = reshape(C{1}(1:3),3,1);
    
    C           = textscan(fid, '%f', 4);
    log(i).Quat = reshape(C{1}(1:4),4,1);
    
    % gvec is the whole 22 x nMeasGvec array of columns
    C           = textscan(fid, '%f', 22*log(i).nMeasGvec);
    log(i).refl = reshape(C{1},22,log(i).nMeasGvec)';
    textscan(fid, '%*[^\n]', 1); % Skip 1 lines
end
fclose(fid);
